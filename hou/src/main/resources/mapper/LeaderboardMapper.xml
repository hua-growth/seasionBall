<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yxh.mapper.LeaderboardMapper">

    <resultMap id="LeaderboardRowMap" type="com.yxh.vo.LeaderboardRowVO">
        <result column="rank_val"       property="rank"/>
        <result column="nickname"       property="nickname"/>
        <result column="total_score"    property="totalScore"/>
        <result column="hit_count"      property="finishCount"/>
        <result column="avatar_url"     property="avatarUrl"/>
        <result column="video_cover_url" property="videoCoverUrl"/>
        <result column="video_url"      property="videoUrl"/>
    </resultMap>

    <!-- season + user_profile + leaderboard_entry 联表查询 -->
    <select id="selectLeaderboardBySeason"
            parameterType="string"
            resultMap="LeaderboardRowMap">
        SELECT
            /* 若有手动 rank_manual 则优先，否则按排序生成行号 */
            IFNULL(le.rank_manual,
                   @rownum := @rownum + 1) AS rank_val,
            up.nickname,
            le.total_score,
            le.hit_count,
            up.avatar_url,
            le.video_cover_url,
            le.video_url
        FROM
                (SELECT @rownum := 0) AS r,
                season s
                    JOIN leaderboard_entry le ON s.id = le.season_id
                    JOIN user_profile up ON le.user_id = up.id
        WHERE
            s.code = #{seasonCode}
        ORDER BY
            IFNULL(le.rank_manual, 999999) ASC,
            le.total_score DESC,
            le.hit_count DESC,
            le.id ASC
    </select>
</mapper>
