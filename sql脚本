-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE IF NOT EXISTS likesports DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

USE likesports;

-- èµ›å­£è¡¨
CREATE TABLE IF NOT EXISTS season (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) NOT NULL UNIQUE COMMENT 'èµ›å­£ä»£ç ï¼šv1, v2, v3',
    name VARCHAR(200) NOT NULL COMMENT 'èµ›å­£åç§°',
    prize_pool INT DEFAULT 0 COMMENT 'å¥–é‡‘æ± é‡‘é¢ï¼ˆå…ƒï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èµ›å­£è¡¨';

-- ç”¨æˆ·èµ„æ–™è¡¨
CREATE TABLE IF NOT EXISTS user_profile (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    nickname VARCHAR(100) NOT NULL COMMENT 'æ˜µç§°',
    avatar_url VARCHAR(500) COMMENT 'å¤´åƒURL',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ç”¨æˆ·èµ„æ–™è¡¨';

-- ä¸ºæ˜µç§°æ·»åŠ å”¯ä¸€ç´¢å¼•ï¼Œé¿å…é‡å¤ç”¨æˆ·
ALTER TABLE user_profile ADD UNIQUE INDEX idx_nickname (nickname);

-- æ’è¡Œæ¦œæ¡ç›®è¡¨
CREATE TABLE IF NOT EXISTS leaderboard_entry (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    season_id BIGINT NOT NULL COMMENT 'èµ›å­£ID',
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
    total_score INT NOT NULL DEFAULT 0 COMMENT 'æ€»å‡ºæ‰‹æ•°',
    hit_count INT NOT NULL DEFAULT 0 COMMENT 'å‘½ä¸­æ•°',
    video_cover_url VARCHAR(500) COMMENT 'è§†é¢‘å°é¢URL',
    video_url VARCHAR(500) DEFAULT NULL COMMENT 'è§†é¢‘æ’­æ”¾URL',
    rank_manual INT COMMENT 'æ‰‹åŠ¨æ’åï¼ˆå¯é€‰ï¼Œç”¨äºå¹¶åˆ—æ’åï¼‰',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (season_id) REFERENCES season(id) ON DELETE CASCADE,
    FOREIGN KEY (user_id) REFERENCES user_profile(id) ON DELETE CASCADE,
    INDEX idx_season_id (season_id),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='æ’è¡Œæ¦œæ¡ç›®è¡¨';

-- æ’å…¥èµ›å­£æ•°æ®
INSERT INTO season (code, name, prize_pool) VALUES
('v1', 'ã€Œä¸‰åˆ†çƒ2åˆ†é’Ÿè‡ªæŠ•è‡ªæŠ¢ã€ å‘¨åº¦æŒ‘æˆ˜', 500),
('v2', 'ã€Œè¿ç»­ç½šçƒå‘½ä¸­ã€ å‘¨åº¦æŒ‘æˆ˜', 500),
('v3', 'ã€Œä¸‰åˆ†çƒ2åˆ†é’Ÿè‡ªæŠ•è‡ªæ¡ã€æœˆèµ›-å½“å‰å¥–é‡‘æ± 3000å…ƒ', 3000)
ON DUPLICATE KEY UPDATE
    name = VALUES(name),
    prize_pool = VALUES(prize_pool);

-- æ¸…ç©ºç°æœ‰ç”¨æˆ·å’Œæ’è¡Œæ¦œæ•°æ®
DELETE FROM leaderboard_entry;
DELETE FROM user_profile;
ALTER TABLE user_profile AUTO_INCREMENT = 1;
ALTER TABLE leaderboard_entry AUTO_INCREMENT = 1;

-- æ’å…¥ç”¨æˆ·æ•°æ®ï¼ˆæ ¹æ®ä½ æä¾›çš„ä¸‰ä¸ªèµ›å­£çš„æ‰€æœ‰ç”¨æˆ·ï¼‰
INSERT INTO user_profile (nickname, avatar_url) VALUES
-- v1èµ›å­£ç”¨æˆ·
('å…­è€³çŒ•ç†Š', 'https://download.like-sports.com/leaderboard/v1/lemx.jpg'),
('y', 'https://download.like-sports.com/leaderboard/v1/y.jpg'),
('è™åæ­²', 'https://download.like-sports.com/leaderboard/v1/hss.jpg'),
('ï¼', 'https://download.like-sports.com/leaderboard/v1/t.jpg'),
('ğŸ€qiao', 'https://download.like-sports.com/leaderboard/v1/q.jpg'),
('H', 'https://download.like-sports.com/leaderboard/v1/h.jpg'),
('å´ä¹¾', 'https://download.like-sports.com/leaderboard/v1/wq.jpg'),
('å¤©ä½¿ä¹‹ç¿¼FLY', 'https://download.like-sports.com/leaderboard/v1/fly.jpg'),
('vè€äº”', 'https://download.like-sports.com/leaderboard/v1/vlw.jpg'),
('ç†Šå«‚', 'https://download.like-sports.com/leaderboard/v1/xs.jpg'),

-- v2èµ›å­£æ–°å¢ç”¨æˆ·
('æœ‰çƒå¿…åº”å´æ•™ç»ƒ', 'https://download.like-sports.com/leaderboard/v1/wjl.jpg'),
('Richard', 'https://download.like-sports.com/leaderboard/v1/richard.jpg'),
('é™ˆé¹è¾‰', 'https://download.like-sports.com/leaderboard/v1/cph.jpg'),
('T_MACğŸ€ğŸ€', 'https://download.like-sports.com/leaderboard/v1/tmac.jpg'),

-- v3èµ›å­£ç”¨æˆ·
('é­è”ƒ', 'https://download.like-sports.com/leaderboard/v1/wq-2.jpg'),
('å°‘å¹´', 'https://download.like-sports.com/leaderboard/v1/sn.jpg'),
('æç¿°ä¾¨', 'https://download.like-sports.com/leaderboard/v1/lhq.jpg'),
('ç‹å¸…', 'https://download.like-sports.com/leaderboard/v1/ws-2.jpg'),
('å°å®‹åŒå­¦', 'https://download.like-sports.com/leaderboard/v1/xstx.jpg'),
('ğŸ‡¨ğŸ‡³', 'https://download.like-sports.com/leaderboard/v1/hq.jpg'),
('ç‹é¹åšNO1', 'https://download.like-sports.com/leaderboard/v1/wpb.jpg')
ON DUPLICATE KEY UPDATE
    avatar_url = VALUES(avatar_url);

-- æ’å…¥v1èµ›å­£æ•°æ®ï¼ˆä¸‰åˆ†çƒ2åˆ†é’Ÿè‡ªæŠ•è‡ªæŠ¢ï¼‰
INSERT INTO leaderboard_entry (season_id, user_id, total_score, hit_count, video_cover_url, video_url, rank_manual) VALUES
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'å…­è€³çŒ•ç†Š'), 20, 19, 'https://download.like-sports.com/leaderboard/v1/lemx.jpg', 'https://download.like-sports.com/leaderboard/v1/lemx.mp4', 1),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'y'), 19, 19, 'https://download.like-sports.com/leaderboard/v1/y.jpg', 'https://download.like-sports.com/leaderboard/v1/y-2.mp4', 2),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'è™åæ­²'), 20, 17, 'https://download.like-sports.com/leaderboard/v1/hss.jpg', 'https://download.like-sports.com/leaderboard/v1/hss.mp4', 3),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'ï¼'), 20, 16, 'https://download.like-sports.com/leaderboard/v1/t.jpg', 'https://download.like-sports.com/leaderboard/v1/t.mp4', 4),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'ğŸ€qiao'), 21, 16, 'https://download.like-sports.com/leaderboard/v1/q.jpg', 'https://download.like-sports.com/leaderboard/v1/q-2.mp4', 4),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'H'), 20, 16, 'https://download.like-sports.com/leaderboard/v1/h.jpg', 'https://download.like-sports.com/leaderboard/v1/h.mp4', 4),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'å´ä¹¾'), 20, 16, 'https://download.like-sports.com/leaderboard/v1/wq.jpg', 'https://download.like-sports.com/leaderboard/v1/wq.mp4', 4),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'å¤©ä½¿ä¹‹ç¿¼FLY'), 18, 16, 'https://download.like-sports.com/leaderboard/v1/fly.jpg', 'https://download.like-sports.com/leaderboard/v1/fly-2.mp4', 4),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'vè€äº”'), 19, 14, 'https://download.like-sports.com/leaderboard/v1/vlw.jpg', 'https://download.like-sports.com/leaderboard/v1/vlw-2.mp4', 9),
((SELECT id FROM season WHERE code = 'v1'), (SELECT id FROM user_profile WHERE nickname = 'ç†Šå«‚'), 18, 13, 'https://download.like-sports.com/leaderboard/v1/xs.jpg', 'https://download.like-sports.com/leaderboard/v1/xs.mp4', 10);

-- æ’å…¥v2èµ›å­£æ•°æ®ï¼ˆè¿ç»­ç½šçƒå‘½ä¸­ï¼‰
INSERT INTO leaderboard_entry (season_id, user_id, total_score, hit_count, video_cover_url, video_url, rank_manual) VALUES
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'å…­è€³çŒ•ç†Š'), 60, 60, 'https://download.like-sports.com/leaderboard/v1/lemx.jpg', 'https://download.like-sports.com/leaderboard/v1/lemx-21.mp4', 1),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'å´ä¹¾'), 59, 59, 'https://download.like-sports.com/leaderboard/v1/wq.jpg', 'https://download.like-sports.com/leaderboard/v1/wq-21.mp4', 2),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'y'), 45, 45, 'https://download.like-sports.com/leaderboard/v1/y.jpg', 'https://download.like-sports.com/leaderboard/v1/y-21.mp4', 3),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'å¤©ä½¿ä¹‹ç¿¼FLY'), 37, 37, 'https://download.like-sports.com/leaderboard/v1/fly.jpg', 'https://download.like-sports.com/leaderboard/v1/fly-21.mp4', 4),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'ğŸ€qiao'), 37, 37, 'https://download.like-sports.com/leaderboard/v1/q.jpg', 'https://download.like-sports.com/leaderboard/v1/q-22.mp4', 4),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'æœ‰çƒå¿…åº”å´æ•™ç»ƒ'), 34, 34, 'https://download.like-sports.com/leaderboard/v1/wjl.jpg', 'https://download.like-sports.com/leaderboard/v1/wjl-21.mp4', 6),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'Richard'), 32, 32, 'https://download.like-sports.com/leaderboard/v1/richard.jpg', 'https://download.like-sports.com/leaderboard/v1/richard-21.mp4', 7),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'é™ˆé¹è¾‰'), 29, 29, 'https://download.like-sports.com/leaderboard/v1/cph.jpg', 'https://download.like-sports.com/leaderboard/v1/cph-22.mp4', 8),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'vè€äº”'), 26, 26, 'https://download.like-sports.com/leaderboard/v1/vlw.jpg', 'https://download.like-sports.com/leaderboard/v1/vlw-21.mp4', 9),
((SELECT id FROM season WHERE code = 'v2'), (SELECT id FROM user_profile WHERE nickname = 'T_MACğŸ€ğŸ€'), 23, 23, 'https://download.like-sports.com/leaderboard/v1/tmac.jpg', 'https://download.like-sports.com/leaderboard/v1/tmac-22.mp4', 10);

-- æ’å…¥v3èµ›å­£æ•°æ®ï¼ˆä¸‰åˆ†çƒ2åˆ†é’Ÿè‡ªæŠ•è‡ªæ¡æœˆèµ›ï¼‰
INSERT INTO leaderboard_entry (season_id, user_id, total_score, hit_count, video_cover_url, video_url, rank_manual) VALUES
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'é­è”ƒ'), 23, 22, 'https://download.like-sports.com/leaderboard/v1/wq-2.jpg', 'https://download.like-sports.com/leaderboard/v1/wq-2-31.mp4', 1),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'å°‘å¹´'), 23, 21, 'https://download.like-sports.com/leaderboard/v1/sn.jpg', 'https://download.like-sports.com/leaderboard/v1/sn-32.mp4', 2),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'å…­è€³çŒ•ç†Š'), 21, 20, 'https://download.like-sports.com/leaderboard/v1/lemx.jpg', 'https://download.like-sports.com/leaderboard/v1/lemx-31.mp4', 3),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'æç¿°ä¾¨'), 20, 20, 'https://download.like-sports.com/leaderboard/v1/lhq.jpg', 'https://download.like-sports.com/leaderboard/v1/lhq-32.mp4', 3),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'ç‹å¸…'), 21, 20, 'https://download.like-sports.com/leaderboard/v1/ws-2.jpg', 'https://download.like-sports.com/leaderboard/v1/ws-2-31.mp4', 3),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'æœ‰çƒå¿…åº”å´æ•™ç»ƒ'), 20, 19, 'https://download.like-sports.com/leaderboard/v1/wjl.jpg', 'https://download.like-sports.com/leaderboard/v1/wjl-32.mp4', 6),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'ğŸ€qiao'), 23, 19, 'https://download.like-sports.com/leaderboard/v1/q.jpg', 'https://download.like-sports.com/leaderboard/v1/q-34.mp4', 7),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'å°å®‹åŒå­¦'), 22, 19, 'https://download.like-sports.com/leaderboard/v1/xstx.jpg', 'https://download.like-sports.com/leaderboard/v1/xstx-31.mp4', 8),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'ğŸ‡¨ğŸ‡³'), 22, 19, 'https://download.like-sports.com/leaderboard/v1/hq.jpg', 'https://download.like-sports.com/leaderboard/v1/hq-31.mp4', 9),
((SELECT id FROM season WHERE code = 'v3'), (SELECT id FROM user_profile WHERE nickname = 'ç‹é¹åšNO1'), 22, 19, 'https://download.like-sports.com/leaderboard/v1/wpb.jpg', 'https://download.like-sports.com/leaderboard/v1/wpb-31.mp4', 10);

-- éªŒè¯æ•°æ®æ’å…¥ç»“æœ
SELECT
    s.code as èµ›å­£ä»£ç ,
    s.name as èµ›å­£åç§°,
    COUNT(*) as è®°å½•æ•°
FROM leaderboard_entry le
JOIN season s ON le.season_id = s.id
GROUP BY s.id, s.code, s.name
ORDER BY s.code;

-- æŸ¥çœ‹å„èµ›å­£å‰5åæ•°æ®ç¤ºä¾‹
SELECT
    s.code as èµ›å­£ä»£ç ,
    s.name as èµ›å­£åç§°,
    le.rank_manual as æ’å,
    u.nickname as æ˜µç§°,
    le.total_score as å‡ºæ‰‹æ•°,
    le.hit_count as å‘½ä¸­æ•°,
    CONCAT(FORMAT((le.hit_count/le.total_score)*100, 1), '%') as å‘½ä¸­ç‡,
    u.avatar_url as å¤´åƒ,
    le.video_cover_url as è§†é¢‘å°é¢,
    le.video_url as è§†é¢‘åœ°å€
FROM leaderboard_entry le
JOIN season s ON le.season_id = s.id
JOIN user_profile u ON le.user_id = u.id
WHERE s.code = 'v1'
ORDER BY le.rank_manual
LIMIT 5;

-- æ€»è®°å½•æ•°ç»Ÿè®¡
SELECT COUNT(*) as æ€»æ’è¡Œæ¦œè®°å½•æ•° FROM leaderboard_entry;
SELECT COUNT(*) as æ€»ç”¨æˆ·æ•° FROM user_profile;

-- æŸ¥çœ‹æ‰€æœ‰èµ›å­£çš„æ‰€æœ‰æ•°æ®
SELECT
    s.code as èµ›å­£ä»£ç ,
    s.name as èµ›å­£åç§°,
    s.prize_pool as å¥–é‡‘æ± ,
    le.rank_manual as æ’å,
    u.nickname as æ˜µç§°,
    le.total_score as å‡ºæ‰‹æ•°,
    le.hit_count as å‘½ä¸­æ•°,
    CONCAT(FORMAT((le.hit_count/le.total_score)*100, 1), '%') as å‘½ä¸­ç‡
FROM leaderboard_entry le
JOIN season s ON le.season_id = s.id
JOIN user_profile u ON le.user_id = u.id
ORDER BY s.code, le.rank_manual;
